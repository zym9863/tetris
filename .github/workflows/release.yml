name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.8'  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build Windows executable
      run: flutter build windows --release
    
    - name: Create Windows archive
      run: |
        cd build\windows\x64\runner\Release
        7z a -tzip ..\..\..\..\tetris-windows.zip *
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: tetris-windows
        path: tetris-windows.zip

  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.8'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build Android APK
      run: flutter build apk --release --split-per-abi
    
    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tetris-android
        path: build/app/outputs/flutter-apk/*.apk

  release:
    needs: [build-windows, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: tetris-windows
        path: ./artifacts/
    
    - name: Download Android artifacts
      uses: actions/download-artifact@v4
      with:
        name: tetris-android
        path: ./artifacts/
    
    - name: Get tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Release ${{ steps.tag.outputs.tag }}
        draft: false
        prerelease: false
        files: |
          ./artifacts/tetris-windows.zip
          ./artifacts/*.apk
        body: |
          ## ğŸ“± Tetris Game Release ${{ steps.tag.outputs.tag }}
          
          ### ğŸš€ æ–°ç‰ˆæœ¬ç‰¹æ€§
          - æ”¯æŒWindowså¹³å°
          - æ”¯æŒAndroidå¹³å°ï¼ˆå¤šæ¶æ„APKï¼‰
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `tetris-windows.zip`ï¼Œè§£å‹åè¿è¡Œ `tetris.exe`
          - **Androidç”¨æˆ·**: æ ¹æ®è®¾å¤‡æ¶æ„ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶ï¼š
            - `app-arm64-v8a-release.apk` - é€‚ç”¨äº64ä½ARMè®¾å¤‡ï¼ˆæ¨èï¼‰
            - `app-armeabi-v7a-release.apk` - é€‚ç”¨äº32ä½ARMè®¾å¤‡
            - `app-x86_64-release.apk` - é€‚ç”¨äº64ä½x86è®¾å¤‡
          
          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10åŠä»¥ä¸Šç‰ˆæœ¬
          - **Android**: Android 5.0 (API 21)åŠä»¥ä¸Šç‰ˆæœ¬
          
          ---
          
          æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          æäº¤å“ˆå¸Œ: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
